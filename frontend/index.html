<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rallymate - AI Table Tennis Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            color: white;
        }

        h1 {
            font-size: 3.5em;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
        }

        .tab:hover:not(:disabled) {
            background: #f5f5f5;
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            background: #f0f0ff;
            font-weight: 600;
        }

        .tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Tab */
        .home-content {
            text-align: center;
            padding: 60px 20px;
        }

        .ping-pong-ball {
            width: 150px;
            height: 150px;
            background: white;
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .ping-pong-ball::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ff6b6b;
            top: 50%;
            transform: translateY(-50%) rotate(-20deg);
        }

        .ping-pong-ball::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ff6b6b;
            top: 50%;
            transform: translateY(-50%) rotate(20deg);
        }

        .start-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 48px;
            font-size: 1.2em;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin-bottom: 20px;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .upload-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #f8f9ff;
            border-radius: 15px;
        }

        .upload-section.active {
            display: block;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 12px 30px;
            background: white;
            border: 2px dashed #667eea;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-label:hover {
            background: #f0f0ff;
            border-color: #764ba2;
        }

        .analyze-button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 36px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .analyze-button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .analyze-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        #videoPreviewContainer {
            margin-top: 30px;
        }

        #videoPreview {
            width: 100%;
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        #analysisCompleteSection {
            margin-top: 20px;
            text-align: center;
        }

        .complete-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Video Tab */
        .video-container {
            text-align: center;
        }

        video {
            width: 100%;
            max-width: 900px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            background: black;
        }

        /* Diagrams Tab */
        .diagrams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .diagram-item {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            position: relative;
            cursor: pointer;
        }

        .diagram-item img {
            width: 100%;
            border-radius: 8px;
            transition: transform 0.3s;
        }

        .diagram-item:hover img {
            transform: scale(1.05);
        }

        .gemini-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .diagram-item:hover .gemini-overlay {
            opacity: 1;
        }

        /* CSV Data Tab */
        .csv-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }

        .modal-close {
            position: absolute;
            top: 30px;
            right: 40px;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Rallymate</h1>
            <p class="subtitle">AI-Powered Table Tennis Coach</p>
            <p>Analyze your game, improve your performance</p>
        </header>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" data-tab="home">Start Analysis</button>
                <button class="tab" data-tab="videos" id="videosTab" disabled>Output Videos</button>
                <button class="tab" data-tab="diagrams" id="diagramsTab" disabled>Diagrams</button>
                <button class="tab" data-tab="coaching" id="coachingTab" disabled>AI Coaching</button>
                <button class="tab" data-tab="data" id="dataTab" disabled>Analysis Data</button>
            </div>

            <!-- Home Tab -->
            <div id="home" class="tab-content active">
                <div class="home-content">
                    <div class="ping-pong-ball">
                        <span style="font-size: 80px; z-index: 2;">üèì</span>
                    </div>
                    <h2 style="margin-bottom: 20px;">Ready to Analyze Your Game?</h2>
                    <p style="color: #666; margin-bottom: 30px;">Upload a video of your table tennis match and get detailed insights</p>
                    <button class="start-button" onclick="showUpload()">Start Analysis</button>

                    <div class="upload-section" id="uploadSection">
                        <h3 style="margin-bottom: 20px;">Upload Your Video</h3>
                        <div class="file-input-wrapper">
                            <input type="file" id="videoFile" accept="video/*" onchange="handleFileSelect(event)">
                            <label for="videoFile" class="file-label">
                                <span id="fileName">Choose Video File</span>
                            </label>
                        </div>
                        <button class="analyze-button" id="analyzeBtn" onclick="analyzeVideo()" disabled>
                            Analyze Video
                        </button>
                        
                        <div id="videoPreviewContainer" style="display: none;">
                            <h3 style="margin: 20px 0;">Analyzing Your Video...</h3>
                            <video id="videoPreview" controls></video>
                            
                            <div id="analysisCompleteSection" style="display: none;">
                                <div class="complete-message">
                                    <h3 style="margin-bottom: 10px;">‚úÖ Analysis Complete!</h3>
                                    <p>Your video has been analyzed. View the results below.</p>
                                </div>
                                <button class="analyze-button" onclick="viewAnalyzedVideo()" style="background: #667eea; margin-right: 10px;">
                                    üé• View Analyzed Video
                                </button>
                                <button class="analyze-button" onclick="viewDiagrams()" style="background: #4caf50; margin-right: 10px;">
                                    üìä View Diagrams
                                </button>
                                <button class="analyze-button" onclick="viewAnalysisData()" style="background: #ff9800;">
                                    üìà View Analysis Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Videos Tab -->
            <div id="videos" class="tab-content">
                <div class="video-container">
                    <h2 style="margin-bottom: 20px;">Output Videos</h2>
                    <div id="videoPlayer"></div>
                </div>
            </div>

            <!-- Diagrams Tab -->
            <div id="diagrams" class="tab-content">
                <h2 style="margin-bottom: 20px;">Analysis Diagrams</h2>
                <div id="diagramsGrid" class="diagrams-grid"></div>
            </div>

            <!-- Coaching Tab -->
            <div id="coaching" class="tab-content">
                <h2 style="margin-bottom: 20px;">AI Coaching Insights</h2>
                <div id="coachingContainer">
                    <div class="loading" style="display: none;" id="coachingLoading">Analyzing performance data with AI...</div>
                    <div id="coachingContent" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Data Tab -->
            <div id="data" class="tab-content">
                <h2 style="margin-bottom: 20px;">Analysis Data</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
                    <button class="player-tab active" data-player="player1" onclick="switchPlayerData('player1')" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        Ashar (Player 1)
                    </button>
                    <button class="player-tab" data-player="player2" onclick="switchPlayerData('player2')" style="padding: 10px 20px; background: #e0e0e0; color: #666; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        Ashwani (Player 2)
                    </button>
                </div>
                
                <div class="csv-container" id="csvContainer"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="imageModal" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <img id="modalImage" src="" alt="Fullscreen">
    </div>

    <script>
        const GEMINI_API_KEY = 'AIzaSyDx-xa7kjHlWwOQIM_mlm2rIDOn8EH1tEw';
        const ELEVENLABS_API_KEY = 'sk_6d09c01893945be9d97377004f6b6ef2f620892861ff0cd7';
        let selectedFile = null;
        let currentCoachingText = { ashar: '', ashwani: '' };
        let currentAudio = { ashar: null, ashwani: null };

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.disabled) return;
                
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                
                if (tabName === 'videos') {
                    loadVideos();
                } else if (tabName === 'diagrams') {
                    loadDiagrams();
                } else if (tabName === 'coaching') {
                    loadCoachingInsights();
                } else if (tabName === 'data') {
                    loadCSVData();
                }
            });
        });

        function showUpload() {
            document.getElementById('uploadSection').classList.add('active');
        }

        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                document.getElementById('fileName').textContent = selectedFile.name;
                document.getElementById('analyzeBtn').disabled = false;
                
                const videoPreview = document.getElementById('videoPreview');
                const videoURL = URL.createObjectURL(selectedFile);
                videoPreview.src = videoURL;
            }
        }

        function analyzeVideo() {
            if (!selectedFile) return;

            const analyzeBtn = document.getElementById('analyzeBtn');
            const videoPreviewContainer = document.getElementById('videoPreviewContainer');
            const videoPreview = document.getElementById('videoPreview');
            const analysisCompleteSection = document.getElementById('analysisCompleteSection');
            
            videoPreviewContainer.style.display = 'block';
            analysisCompleteSection.style.display = 'none';
            analyzeBtn.disabled = true;
            
            videoPreview.play();

            setTimeout(() => {
                analysisCompleteSection.style.display = 'block';
                videoPreview.pause();
                
                document.getElementById('videosTab').disabled = false;
                document.getElementById('diagramsTab').disabled = false;
                document.getElementById('coachingTab').disabled = false;
                document.getElementById('dataTab').disabled = false;
            }, 5000);
        }

        function viewAnalyzedVideo() {
            switchToTab('videos');
        }

        function viewDiagrams() {
            switchToTab('diagrams');
        }

        function viewAnalysisData() {
            switchToTab('data');
        }

        function switchToTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'videos') {
                loadVideos();
            } else if (tabName === 'diagrams') {
                loadDiagrams();
            } else if (tabName === 'coaching') {
                loadCoachingInsights();
            } else if (tabName === 'data') {
                loadCSVData();
            }
        }

        async function loadVideos() {
            const videoPlayer = document.getElementById('videoPlayer');
            
            try {
                const response = await fetch('http://localhost:5000/videos');
                const videos = await response.json();
                
                if (videos.length === 0) {
                    videoPlayer.innerHTML = '<div class="empty-state"><p>No output videos found.</p></div>';
                    return;
                }
                
                // Create video element the same way as input video
                const videoUrl = `http://localhost:5000/video/${videos[0]}`;
                videoPlayer.innerHTML = `
                    <h3 style="margin-bottom: 20px;">${videos[0]}</h3>
                    <video id="outputVideo" controls style="width: 100%; max-width: 900px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); background: black;"></video>
                `;
                
                // Set video source using JavaScript like input video
                const video = document.getElementById('outputVideo');
                video.src = videoUrl;
                video.load();
                video.play();
                
            } catch (error) {
                videoPlayer.innerHTML = '<div class="empty-state"><p>Error loading videos.</p></div>';
                console.error('Error loading videos:', error);
            }
        }

        async function loadDiagrams() {
            const diagramsGrid = document.getElementById('diagramsGrid');
            
            try {
                const response = await fetch('http://localhost:5000/diagrams');
                const diagrams = await response.json();
                
                if (diagrams.length === 0) {
                    diagramsGrid.innerHTML = '<div class="empty-state"><p>No diagrams found.</p></div>';
                    return;
                }
                
                diagramsGrid.innerHTML = diagrams.map(diagram => `
                    <div class="diagram-item" onclick="explainWithGemini('http://localhost:5000/diagram/${diagram}', '${diagram}')">
                        <img src="http://localhost:5000/diagram/${diagram}" alt="${diagram}">
                        <div class="gemini-overlay">‚ú® Explain with Gemini</div>
                    </div>
                `).join('');
                
            } catch (error) {
                diagramsGrid.innerHTML = '<div class="empty-state"><p>Error loading diagrams.</p></div>';
            }
        }

        async function loadCSVData(playerFilter = 'player1') {
            const csvContainer = document.getElementById('csvContainer');
            csvContainer.innerHTML = '<div class="loading">Loading data...</div>';
            
            try {
                const filesResponse = await fetch('http://localhost:5000/csv-files');
                const files = await filesResponse.json();
                
                if (files.length === 0) {
                    csvContainer.innerHTML = '<div class="empty-state"><p>No analysis data found.</p></div>';
                    return;
                }
                
                const filename = files[0];
                const response = await fetch(`http://localhost:5000/csv/${filename}`);
                const data = await response.json();
                
                if (data.length === 0) {
                    csvContainer.innerHTML = '<div class="empty-state"><p>No data found.</p></div>';
                    return;
                }
                
                // Filter data by player
                const filteredData = playerFilter === 'player1' 
                    ? data.filter(row => row.Player === 'Player_1')
                    : data.filter(row => row.Player === 'Player_2');
                
                if (filteredData.length === 0) {
                    csvContainer.innerHTML = '<div class="empty-state"><p>No data found for this player.</p></div>';
                    return;
                }
                
                const headers = Object.keys(filteredData[0]);
                
                csvContainer.innerHTML = `
                    <table>
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${filteredData.map(row => `
                                <tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
            } catch (error) {
                csvContainer.innerHTML = '<div class="empty-state"><p>Error loading data.</p></div>';
            }
        }

        function switchPlayerData(player) {
            // Update button styles
            document.querySelectorAll('.player-tab').forEach(btn => {
                if (btn.dataset.player === player) {
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                    btn.classList.add('active');
                } else {
                    btn.style.background = '#e0e0e0';
                    btn.style.color = '#666';
                    btn.classList.remove('active');
                }
            });
            
            // Load data for selected player
            loadCSVData(player);
        }

        async function explainWithGemini(imageSrc, imageName) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.classList.add('active');
            
            let explanationDiv = document.getElementById('geminiExplanation');
            if (!explanationDiv) {
                explanationDiv = document.createElement('div');
                explanationDiv.id = 'geminiExplanation';
                explanationDiv.style.cssText = `
                    position: absolute;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(255, 255, 255, 0.95);
                    padding: 20px 30px;
                    border-radius: 15px;
                    max-width: 80%;
                    max-height: 30%;
                    overflow-y: auto;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    color: #333;
                    font-size: 0.9em;
                    line-height: 1.6;
                `;
                modal.appendChild(explanationDiv);
            }
            
            explanationDiv.innerHTML = '<div style="text-align: center;">ü§ñ Analyzing with Gemini AI...</div>';
            
            try {
                // Fetch image and convert to base64
                const response = await fetch(imageSrc);
                if (!response.ok) throw new Error('Failed to fetch image');
                
                const blob = await response.blob();
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
                
                console.log('Calling Gemini API...');
                
                // Call Gemini API
                const geminiResponse = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { 
                                        text: "You are Rallymate, an expert AI table tennis coach analyzing a match between two players. This diagram shows analysis data from their game. Provide a detailed coaching analysis covering: 1) What the diagram reveals about each player's technique and positioning, 2) Shot patterns and movement trajectories visible in the data, 3) Specific strengths and weaknesses for each player, 4) Actionable coaching advice for improvement. Be encouraging but provide concrete technical feedback that helps them level up their game." 
                                    },
                                    { 
                                        inline_data: { 
                                            mime_type: "image/png", 
                                            data: base64 
                                        } 
                                    }
                                ]
                            }]
                        })
                    }
                );
                
                if (!geminiResponse.ok) {
                    const errorData = await geminiResponse.json();
                    console.error('Gemini API error:', errorData);
                    throw new Error(`Gemini API error: ${JSON.stringify(errorData)}`);
                }
                
                const data = await geminiResponse.json();
                console.log('Gemini response:', data);
                
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    const explanation = data.candidates[0].content.parts[0].text;
                    explanationDiv.innerHTML = `
                        <div style="margin-bottom: 10px; font-weight: 600; color: #667eea; font-size: 1.1em;">
                            ‚ú® Gemini AI Analysis
                        </div>
                        <div>${explanation.replace(/\n/g, '<br>')}</div>
                    `;
                } else {
                    throw new Error('No valid response from Gemini');
                }
                
            } catch (error) {
                console.error('Gemini API Error:', error);
                explanationDiv.innerHTML = `
                    <div style="color: #d32f2f;">
                        ‚ùå Error getting analysis: ${error.message}
                    </div>
                `;
            }
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        async function loadCoachingInsights() {
            const coachingLoading = document.getElementById('coachingLoading');
            const coachingContent = document.getElementById('coachingContent');
            
            coachingLoading.style.display = 'block';
            coachingContent.innerHTML = '';
            
            try {
                // Get CSV data
                const filesResponse = await fetch('http://localhost:5000/csv-files');
                const files = await filesResponse.json();
                
                if (files.length === 0) {
                    coachingContent.innerHTML = '<div class="empty-state"><p>No analysis data found.</p></div>';
                    coachingLoading.style.display = 'none';
                    return;
                }
                
                const filename = files[0];
                const response = await fetch(`http://localhost:5000/csv/${filename}`);
                const data = await response.json();
                
                // Separate data by player
                const player1Data = data.filter(row => row.Player === 'Player_1');
                const player2Data = data.filter(row => row.Player === 'Player_2');
                
                // Generate coaching insights for both players
                const asharInsights = await getPlayerCoaching('Ashar', player1Data);
                const ashwaniInsights = await getPlayerCoaching('Ashwani', player2Data);
                
                coachingLoading.style.display = 'none';
                
                coachingContent.innerHTML = `
                    <div style="background: #f8f9ff; padding: 25px; border-radius: 15px; border-left: 5px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #667eea; font-size: 1.5em;">üéØ Ashar's Coaching</h3>
                            <button onclick="listenToCoaching('ashar')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px;">
                                üéß Listen to Your Coach
                            </button>
                        </div>
                        <div style="line-height: 1.8; color: #333;">${asharInsights}</div>
                    </div>
                    <div style="background: #f8f9ff; padding: 25px; border-radius: 15px; border-left: 5px solid #764ba2;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #764ba2; font-size: 1.5em;">üéØ Ashwani's Coaching</h3>
                            <button onclick="listenToCoaching('ashwani')" style="background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px;">
                                üéß Listen to Your Coach
                            </button>
                        </div>
                        <div style="line-height: 1.8; color: #333;">${ashwaniInsights}</div>
                    </div>
                `;
                
            } catch (error) {
                coachingLoading.style.display = 'none';
                coachingContent.innerHTML = '<div class="empty-state"><p>Error loading coaching insights.</p></div>';
                console.error('Error loading coaching:', error);
            }
        }

        async function getPlayerCoaching(playerName, playerData) {
            if (!playerData || playerData.length === 0) {
                return `<p>No data available for ${playerName}.</p>`;
            }
            
            // Prepare data summary for Gemini
            const summary = {
                totalShots: playerData.length,
                forehandShots: playerData.filter(r => r.Shot_Type === 'Forehand').length,
                backhandShots: playerData.filter(r => r.Shot_Type === 'Backhand').length,
                avgRacketVelocity: (playerData.reduce((sum, r) => sum + parseFloat(r.Avg_Racket_Velocity_px_s || 0), 0) / playerData.length).toFixed(2),
                avgElbowAngle: (playerData.reduce((sum, r) => sum + parseFloat(r.Avg_Elbow_Angle_deg || 0), 0) / playerData.length).toFixed(2),
                avgTorsoAngle: (playerData.reduce((sum, r) => sum + parseFloat(r.Avg_Torso_Angle_deg || 0), 0) / playerData.length).toFixed(2)
            };
            
            const prompt = `You are Coach Rallymate, a professional table tennis coach with 20 years of experience training Olympic and championship players. You're reviewing ${playerName}'s match performance data and preparing personalized coaching feedback.

Player: ${playerName}
Match Performance Data:
- Total Shots Played: ${summary.totalShots}
- Forehand Shots: ${summary.forehandShots}
- Backhand Shots: ${summary.backhandShots}
- Average Racket Velocity: ${summary.avgRacketVelocity} px/s
- Average Elbow Angle: ${summary.avgElbowAngle}¬∞
- Average Torso Angle: ${summary.avgTorsoAngle}¬∞

Write a coaching message directly to ${playerName} as if you're speaking to them in person after reviewing their match video. Your coaching style is:
- Warm, supportive, and encouraging
- Direct and honest about areas needing improvement
- Specific with technical advice and drills
- Motivational and confidence-building

Start with a brief personal greeting acknowledging something positive from their game. Then provide 5-6 specific, actionable coaching points. Each point should:
1. Identify a specific aspect of their technique or strategy
2. Explain why it matters
3. Give a concrete drill or adjustment they can practice

End with an encouraging note about their potential. Write naturally as if speaking to them face-to-face, using "you" and "your". Keep the tone conversational but professional.`;
            
            try {
                const geminiResponse = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }]
                        })
                    }
                );
                
                if (!geminiResponse.ok) {
                    throw new Error('Gemini API error');
                }
                
                const data = await geminiResponse.json();
                
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    const coachingText = data.candidates[0].content.parts[0].text;
                    
                    // Store the coaching text for audio generation
                    if (playerName === 'Ashar') {
                        currentCoachingText.ashar = coachingText;
                    } else {
                        currentCoachingText.ashwani = coachingText;
                    }
                    
                    return coachingText.replace(/\n/g, '<br>');
                } else {
                    throw new Error('No valid response');
                }
                
            } catch (error) {
                console.error(`Error getting coaching for ${playerName}:`, error);
                return `<p style="color: #d32f2f;">Unable to generate coaching insights at this time.</p>`;
            }
        }

        async function listenToCoaching(player) {
            const playerName = player === 'ashar' ? 'Ashar' : 'Ashwani';
            const coachingText = currentCoachingText[player];
            const button = event.target.closest('button');
            
            // If audio is playing, stop it
            if (currentAudio[player] && !currentAudio[player].paused) {
                currentAudio[player].pause();
                currentAudio[player].currentTime = 0;
                currentAudio[player] = null;
                button.innerHTML = 'üéß Listen to Your Coach';
                button.disabled = false;
                return;
            }
            
            if (!coachingText) {
                alert('No coaching text available. Please wait for the analysis to complete.');
                return;
            }
            
            try {
                // Show loading state
                const originalText = button.innerHTML;
                button.innerHTML = 'üîä Generating audio...';
                button.disabled = true;
                
                // Clean the text (remove HTML tags)
                const cleanText = coachingText.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
                
                // Call ElevenLabs API
                const response = await fetch('https://api.elevenlabs.io/v1/text-to-speech/JBFqnCBsd6RMkjVDRZzb', {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': ELEVENLABS_API_KEY
                    },
                    body: JSON.stringify({
                        text: cleanText,
                        model_id: 'eleven_flash_v2_5',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.75,
                            style: 0.5,
                            use_speaker_boost: true
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('ElevenLabs API error:', errorData);
                    throw new Error('Failed to generate audio');
                }
                
                // Get audio blob and play it
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                currentAudio[player] = audio;
                
                button.innerHTML = '‚è∏Ô∏è Stop Coach';
                button.disabled = false;
                
                audio.play();
                
                audio.onended = () => {
                    button.innerHTML = 'üéß Listen to Your Coach';
                    currentAudio[player] = null;
                    URL.revokeObjectURL(audioUrl);
                };
                
                audio.onerror = () => {
                    button.innerHTML = 'üéß Listen to Your Coach';
                    button.disabled = false;
                    currentAudio[player] = null;
                    URL.revokeObjectURL(audioUrl);
                    alert('Error playing audio');
                };
                
            } catch (error) {
                console.error('Error generating audio:', error);
                alert('Failed to generate audio. Please try again.');
                button.innerHTML = 'üéß Listen to Your Coach';
                button.disabled = false;
                currentAudio[player] = null;
            }
        }
    </script>
</body>
</html>
